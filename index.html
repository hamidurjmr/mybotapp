<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tap & Earn ‚Äî Fixed Wheel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#fff6f2;--card:#fff;--accent1:#4facfe;--accent2:#00f2fe;--warm1:#ff7676;--warm2:#ffb476;--muted:#6b6b6b;}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Roboto,Arial;color:#222;
       background:linear-gradient(180deg,var(--bg),#fff);min-height:100vh;display:flex;flex-direction:column}
  .card{flex:1;overflow:auto;padding:16px}
  header{display:flex;align-items:center;gap:12px}
  .logo{width:50px;height:50px;border-radius:12px;overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:contain}
  .title{font-weight:800;font-size:18px}
  .statusRow{margin-left:auto;display:flex;gap:8px}
  .pill{background:#f8f8f8;padding:6px 12px;border-radius:999px;font-weight:700}
  .wheel-wrap{position:relative;width:86vw;max-width:320px;height:86vw;max-height:320px;margin:18px auto}
  .wheel{width:100%;height:100%;border-radius:50%;transition:transform 4s cubic-bezier(.17,.67,.83,.67);
         box-shadow:0 12px 30px rgba(0,0,0,0.06),inset 0 6px rgba(255,255,255,0.6);transform-origin:50% 50%}
  .wheel.segs{background:conic-gradient(#ffd36e 0 45deg,#ffb476 45deg 90deg,#ff7676 90deg 135deg,
  #ffb6d1 135deg 180deg,#a6e6c6 180deg 225deg,#7fb4ff 225deg 270deg,#dfa6ff 270deg 315deg,#ffd36e 315deg 360deg);
  border:8px solid rgba(255,255,255,0.6)}
  .pointer{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:10;
  width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid var(--warm1)}
  .center-coin{position:absolute;width:88px;height:88px;border-radius:50%;left:50%;top:50%;transform:translate(-50%,-50%);
  background:#ffd36e;display:flex;align-items:center;justify-content:center;border:4px solid #fff;z-index:6}
  .center-coin img{width:60px;height:60px}
  .label{position:absolute;left:50%;top:50%;transform-origin:0 0;font-weight:700;color:#1a1a1a;pointer-events:none}
  .controls{display:flex;gap:10px;margin-top:14px}
  .btn{flex:1;padding:12px;border-radius:12px;border:0;font-weight:800;cursor:pointer}
  .btn-watch{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
  .btn-spin{background:linear-gradient(90deg,var(--warm1),var(--warm2));color:#fff}
  .hint{text-align:center;font-size:13px;color:var(--muted);margin-top:10px}
  .pop{position:fixed;left:50%;top:32%;transform:translate(-50%,-50%) scale(0);background:#fff;padding:10px 16px;border-radius:12px;font-weight:800;
  box-shadow:0 12px 30px rgba(0,0,0,0.12);transition:transform .25s;z-index:120}
  .pop.show{transform:translate(-50%,-50%) scale(1)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:110;visibility:hidden;opacity:0;transition:opacity .2s}
  .overlay.show{visibility:visible;opacity:1}
  .ovCard{background:#fff;padding:18px;border-radius:14px;max-width:300px;text-align:center}
  .meter{height:12px;background:#eee;border-radius:999px;margin-top:14px;overflow:hidden}
  .meter .bar{height:100%;width:0;background:linear-gradient(90deg,#ffd36e,#ff7676)}
  .nav{display:flex;justify-content:space-around;background:#fff;box-shadow:0 -2px 6px rgba(0,0,0,0.1)}
  .nav button{flex:1;padding:12px;border:0;background:none;font-weight:700;cursor:pointer}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th,td{border:1px solid #ccc;padding:6px;text-align:center}
</style>
</head>
<body>
<div class="card" id="spinPage">
  <header>
    <div class="logo"><img src="https://i.ibb.co/LDHjg19m/1000064821-removebg-preview.png" alt="logo"></div>
    <div><div class="title">Tap & Earn</div></div>
    <div class="statusRow">
      <div class="pill">Coins: <span id="points">0</span></div>
      <div class="pill">Lives: <span id="lives">0</span></div>
    </div>
  </header>

  <div class="wheel-wrap">
    <div class="pointer"></div>
    <div id="wheel" class="wheel segs" aria-hidden="true"></div>
    <div class="center-coin"><img src="https://i.ibb.co/LDHjg19m/1000064821-removebg-preview.png" alt="center"></div>
  </div>

  <div style="text-align:center;margin:6px 0"><div class="pill">Daily spins left: <span id="spinsLeft">50</span></div></div>

  <div class="controls">
    <button id="watchBtn" class="btn btn-watch">‚ñ∂Ô∏è Watch (Get 1 Life)</button>
    <button id="spinBtn" class="btn btn-spin">üéØ Spin (Use 1 Life)</button>
  </div>

  <div class="hint">‚ö†Ô∏è You must watch for 14 seconds to earn a life. Daily limit 50 spins.</div>
</div>

<div class="card hidden" id="walletPage">
  <h2>Wallet</h2>
  <p>Balance: <b><span id="usdtBalance">0</span> USDT (BEP20)</b></p>
  <button id="convertBtn" class="btn btn-spin">Convert 1000 Coins ‚Üí 5 USDT (BEP20)</button>
  <h3 style="margin-top:18px">Withdraw</h3>
  <input id="walletAddr" placeholder="Wallet Address (BEP20)" style="width:100%;padding:8px;margin-bottom:6px">
  <input id="withdrawAmt" placeholder="Amount (min 20 USDT)" type="number" style="width:100%;padding:8px;margin-bottom:6px">
  <button id="withdrawBtn" class="btn btn-watch">Withdraw</button>
  <h3 style="margin-top:18px">History</h3>
  <table><thead><tr><th>Address</th><th>Amount (USDT BEP20)</th><th>Status</th></tr></thead><tbody id="historyBody"></tbody></table>
</div>

<div class="nav">
  <button onclick="showPage('spin')">üé° Spin</button>
  <button onclick="showPage('wallet')">üí∞ Wallet</button>
</div>

<!-- Monetag SDK (kept as-is) -->
<script src='//libtl.com/sdk.js' data-zone='9857499' data-sdk='show_9857499'></script>

<!-- Overlay -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="ovCard">
    <div>Watching Ad... wait 14s</div>
    <div class="meter"><div id="bar" class="bar"></div></div>
    <button id="ovCancel">Cancel</button>
  </div>
</div>

<div id="pop" class="pop">+0</div>

<script>
/*
 Fixed wheel behavior:
 - Prevents rotation drift/precision loss by keeping rotation normalized
 - Awards exactly the chosen segment value (no doubling)
 - Uses transitionend to finalize the spin
 - Recomputes labels after spin to keep layout correct
*/

(function(){
  const REQUIRED_MS = 14000;
  const DAILY_MAX_SPINS = 50;
  const SEGMENTS = [5,10,15,20,25,30,50,70];
  const SEG_COUNT = SEGMENTS.length;

  // elements
  const pointsEl = document.getElementById('points');
  const livesEl = document.getElementById('lives');
  const spinsLeftEl = document.getElementById('spinsLeft');
  const wheel = document.getElementById('wheel');
  const watchBtn = document.getElementById('watchBtn');
  const spinBtn = document.getElementById('spinBtn');
  const overlay = document.getElementById('overlay');
  const bar = document.getElementById('bar');
  const ovCancel = document.getElementById('ovCancel');
  const pop = document.getElementById('pop');
  const usdtBalanceEl = document.getElementById('usdtBalance');
  const convertBtn = document.getElementById('convertBtn');
  const withdrawBtn = document.getElementById('withdrawBtn');
  const historyBody = document.getElementById('historyBody');

  // storage keys
  const K = {
    POINTS: 'points_v3',
    LIVES: 'lives_v3',
    DATE: 'date_v3',
    COUNT: 'count_v3',
    USDT: 'usdt_v3',
    HISTORY: 'history_v3'
  };

  // state
  let points = Number(localStorage.getItem(K.POINTS) || 0);
  let lives = Number(localStorage.getItem(K.LIVES) || 0);
  let usdt = Number(localStorage.getItem(K.USDT) || 0);

  // daily reset
  function today(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
  let savedDate = localStorage.getItem(K.DATE) || '';
  let spinCount = Number(localStorage.getItem(K.COUNT) || 0);
  if(savedDate !== today()){
    savedDate = today();
    spinCount = 0;
    localStorage.setItem(K.DATE, savedDate);
    localStorage.setItem(K.COUNT, String(spinCount));
  }

  function saveAll(){
    localStorage.setItem(K.POINTS, String(points));
    localStorage.setItem(K.LIVES, String(lives));
    localStorage.setItem(K.USDT, String(usdt));
    localStorage.setItem(K.COUNT, String(spinCount));
  }

  function showPop(txt){ pop.textContent = txt; pop.classList.add('show'); setTimeout(()=>pop.classList.remove('show'),1200); }

  function refreshUI(){
    pointsEl.textContent = points;
    livesEl.textContent = lives;
    spinsLeftEl.textContent = Math.max(0, DAILY_MAX_SPINS - spinCount);
    usdtBalanceEl.textContent = usdt.toFixed(2);
    spinBtn.disabled = (lives <= 0 || spinCount >= DAILY_MAX_SPINS);
    convertBtn.disabled = (points < 1000);
  }
  refreshUI();

  // draw labels on wheel (relative to wheel dimensions)
  function drawLabels(){
    wheel.querySelectorAll('.label').forEach(n=>n.remove());
    const w = wheel.clientWidth;
    const cx = w/2, cy = w/2;
    const r = Math.min(w,w) * 0.32;
    for(let i=0;i<SEG_COUNT;i++){
      const angle = (360/SEG_COUNT) * i + (360/SEG_COUNT)/2;
      const rad = (angle - 90) * Math.PI/180;
      const x = cx + Math.cos(rad) * r;
      const y = cy + Math.sin(rad) * r;
      const el = document.createElement('div');
      el.className = 'label';
      el.textContent = SEGMENTS[i];
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      el.style.fontSize = Math.max(11, Math.floor(w/22)) + 'px';
      el.style.transform = 'translate(-50%,-50%)';
      wheel.appendChild(el);
    }
  }
  setTimeout(drawLabels, 20);
  window.addEventListener('resize', ()=>{ setTimeout(drawLabels,80); });

  // rotation management
  // keep rotationNormalized in [0,360)
  let currentRotation = 0; // always normalized 0..360
  let isSpinning = false;
  let chosenIndex = null;
  let chosenValue = 0;

  // helper: set rotation visually (with or without transition)
  function setWheelRotation(deg, withTransition = true){
    if(!withTransition){
      wheel.style.transition = 'none';
    } else {
      wheel.style.transition = 'transform 4s cubic-bezier(.17,.67,.83,.67)';
    }
    wheel.style.transform = `rotate(${deg}deg)`;
    // when turning off transition, force reflow so next transitions work properly
    if(!withTransition){
      // force reflow
      void wheel.offsetWidth;
    }
  }

  // spin function using robust math
  function spin(){
    if(isSpinning) return;
    if(lives <= 0){ alert('No lives. Watch ad to earn lives.'); return; }
    if(spinCount >= DAILY_MAX_SPINS){ alert('Daily spin limit reached.'); return; }

    isSpinning = true;
    spinBtn.disabled = true;

    // consume life immediately
    lives = Math.max(0, lives - 1);
    saveAll();
    refreshUI();

    // pick random index
    chosenIndex = Math.floor(Math.random() * SEG_COUNT);
    chosenValue = SEGMENTS[chosenIndex];

    // compute target so that wheel lands with segment center at pointer
    const segSize = 360 / SEG_COUNT;
    const segCenter = chosenIndex * segSize + segSize / 2; // degrees from 0
    // pointer is at 0deg from top; we want wheel rotated such that segment center aligns to pointer
    // If we rotate wheel by (360 - segCenter) degrees relative to 0, segment center moves to pointer.
    // compute minimal extra rotations to produce a nice spin
    const extraRounds = 6 + Math.floor(Math.random() * 3); // 6..8 rounds
    // compute desired absolute rotation = currentRotation + extraRounds*360 + (360 - segCenter) - (currentRotation % 360)
    // but to avoid huge numbers, compute the delta from currentRotationNormalized
    const currentNorm = currentRotation % 360;
    const targetNorm = (360 - segCenter) % 360;
    // deltaNorm = minimal positive rotation from currentNorm to targetNorm
    let deltaNorm = (targetNorm - currentNorm + 360) % 360;
    // choose full rotation delta adding full rounds
    const totalDelta = extraRounds * 360 + deltaNorm;
    const finalRotation = currentRotation + totalDelta;

    // set transition and rotate
    setWheelRotation(finalRotation, true);

    // use transitionend to finalize (handles varying durations & cancels)
    const onTransitionEnd = () => {
      wheel.removeEventListener('transitionend', onTransitionEnd);
      // normalize rotation into 0..360 to avoid huge numbers
      currentRotation = finalRotation % 360;
      // snap transform to normalized rotation without transition (prevents stacking)
      setWheelRotation(currentRotation, false);
      // award prize exactly once
      points += chosenValue;
      spinCount += 1;
      saveAll();
      refreshUI();
      showPop('+' + chosenValue);
      // redraw labels to ensure layout remains correct
      setTimeout(drawLabels, 40);
      isSpinning = false;
      chosenIndex = null;
      chosenValue = 0;
      spinBtn.disabled = false;
    };

    // attach handler
    wheel.addEventListener('transitionend', onTransitionEnd);
  }

  spinBtn.addEventListener('click', spin);

  // Watch / Monetag: call SDK if present, otherwise overlay fallback
  function tryMonetagSdk(){
    try {
      if(typeof window.show_9857499 === 'function'){
        window.show_9857499();
        return true;
      }
    } catch(e){}
    return false;
  }

  let overlayTimer = null;
  function startOverlay(cb){
    overlay.classList.add('show'); bar.style.width = '0%';
    const start = Date.now();
    overlayTimer = setInterval(()=>{
      const elapsed = Date.now() - start;
      bar.style.width = Math.min(100, (elapsed / REQUIRED_MS) * 100) + '%';
      if(elapsed >= REQUIRED_MS){
        clearInterval(overlayTimer); overlayTimer = null; overlay.classList.remove('show');
        if(cb) cb();
      }
    }, 120);
  }

  ovCancel.addEventListener('click', ()=>{
    if(overlayTimer) clearInterval(overlayTimer);
    overlayTimer = null; overlay.classList.remove('show'); showPop('No life');
  });

  watchBtn.addEventListener('click', ()=>{
    const used = tryMonetagSdk();
    startOverlay(()=>{
      lives += 1; saveAll(); refreshUI(); showPop('+1 life');
    });
    if(!used){
      console.info('Monetag SDK not available, used local overlay fallback.');
    }
  });

  // convert & withdraw behavior (same as before)
  convertBtn.addEventListener('click', ()=>{
    if(points < 1000){ alert('Need 1000 coins to convert'); return; }
    points -= 1000; usdt += 5; saveAll(); refreshUI(); showPop('+5 USDT (BEP20)');
  });

  withdrawBtn.addEventListener('click', ()=>{
    const addr = document.getElementById('walletAddr').value.trim();
    const amt = Number(document.getElementById('withdrawAmt').value);
    if(!addr || !amt || amt < 20 || amt > usdt){ alert('Invalid withdraw'); return; }
    usdt -= amt; saveAll(); refreshUI();
    const hist = JSON.parse(localStorage.getItem(K.HISTORY) || '[]');
    hist.push({ addr, amount: amt, status: 'Pending', time: Date.now() });
    localStorage.setItem(K.HISTORY, JSON.stringify(hist));
    renderHistory(); document.getElementById('walletAddr').value = ''; document.getElementById('withdrawAmt').value = '';
    showPop('Withdraw requested');
  });

  // history rendering and auto-complete after 72h
  function renderHistory(){
    const list = JSON.parse(localStorage.getItem(K.HISTORY) || '[]');
    const now = Date.now();
    historyBody.innerHTML = '';
    list.forEach(item=>{
      let status = item.status;
      if(item.status === 'Pending'){
        const elapsed = now - item.time;
        if(elapsed >= 72 * 3600 * 1000){ item.status = 'Completed'; status = 'Completed'; }
        else { status = `Pending (${formatTime((72*3600*1000) - elapsed)})`; }
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(item.addr)}</td><td>${item.amount} USDT</td><td>${status}</td>`;
      historyBody.appendChild(tr);
    });
    localStorage.setItem(K.HISTORY, JSON.stringify(list));
  }

  function formatTime(ms){
    const s = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  }
  function escapeHtml(s){ return (s + '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  renderHistory();
  setInterval(renderHistory, 1000);

  // page switch exposed earlier
  window.showPage = function(p){
    document.getElementById('spinPage').classList.add('hidden');
    document.getElementById('walletPage').classList.add('hidden');
    if(p === 'spin') document.getElementById('spinPage').classList.remove('hidden');
    if(p === 'wallet') document.getElementById('walletPage').classList.remove('hidden');
    renderHistory();
  };

  // initial rotation normalization (ensure CSS transform matches currentRotation)
  // set to 0 on load
  currentRotation = 0;
  setWheelRotation(currentRotation, false);

})();
</script>
</body>
</html>
